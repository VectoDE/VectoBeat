services:
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        DATABASE_URL: ${DATABASE_URL}
    env_file:
      - ./.env
    environment:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: "1"
      PORT: "3060"

      # Datenbanken (intern)
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Lavalink (extern, bereits vorhanden)
      LAVALINK_HOST: lavalink
      LAVALINK_PORT: 2333
      LAVALINK_SECURE: "false"

    restart: unless-stopped
    networks:
      - traefik-public
      - mysql-phpmyadmin_mysql-internal
      - redis_default

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3060/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vectobeat.rule=Host(`vectobeat.uplytech.de`)"
      - "traefik.http.routers.vectobeat.entrypoints=websecure"
      - "traefik.http.routers.vectobeat.tls.certresolver=letsencrypt"
      - "traefik.http.services.vectobeat.loadbalancer.server.port=3060"

  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    env_file:
      - ./.env
    environment:
      CONFIG_PATH: /app/config.yml

      # Datenbanken (intern)
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Lavalink (extern)
      LAVALINK_HOST: lavalink
      LAVALINK_PORT: 2333
      LAVALINK_SECURE: "false"

    volumes:
      - ./bot/config.yml:/app/config.yml:ro
      - ./bot/data:/app/data

    restart: unless-stopped
    networks:
      - mysql-phpmyadmin_mysql-internal
      - redis_default

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python - <<EOF\nimport socket\ns=socket.socket();s.settimeout(5);s.connect(('127.0.0.1',3061));s.close()\nEOF"
        ]
      interval: 30s
      timeout: 5s
      retries: 5

networks:
  traefik-public:
    external: true

  mysql-phpmyadmin_mysql-internal:
    external: true

  redis_default:
    external: true
